<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8" />

  
  <title>用concurrent.futures模块实现并行</title>

  
  
  <link href="//cdn.jsdelivr.net" rel="dns-prefetch">
  <link href="//cdnjs.cloudflare.com" rel="dns-prefetch">
  
  <link href="//at.alicdn.com" rel="dns-prefetch">
  
  <link href="//fonts.googleapis.com" rel="dns-prefetch">
  <link href="//fonts.gstatic.com" rel="dns-prefetch">
  <link href="///disqus.com" rel="dns-prefetch">
  <link href="//c.disquscdn.com" rel="dns-prefetch">
  
  <link href="//www.google-analytics.com" rel="dns-prefetch">
  <link href="//hm.baidu.com" rel="dns-prefetch">

  

  
  <meta name="author" content="Qi Zhang">
  <meta name="description" content="Python实现多线程/多进程，大家常常会用到标准库中的threading和multiprocessing模块。
但从Python3.2开始，标准库为我们提供了concurrent.futures模块，它提供了ThreadPoolExecutor和ProcessPoolExecutor两个类，实现了对threading和multiprocessing的进一步抽象，使得开发者只需编写少量代码即可让程序实现并行计算。
">

  
  
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@gohugoio">
    <meta name="twitter:title" content="用concurrent.futures模块实现并行">
    <meta name="twitter:description" content="Python实现多线程/多进程，大家常常会用到标准库中的threading和multiprocessing模块。
但从Python3.2开始，标准库为我们提供了concurrent.futures模块，它提供了ThreadPoolExecutor和ProcessPoolExecutor两个类，实现了对threading和multiprocessing的进一步抽象，使得开发者只需编写少量代码即可让程序实现并行计算。
">
    <meta name="twitter:image" content="/images/avatar.png">
  

  
  <meta property="og:type" content="article">
  <meta property="og:title" content="用concurrent.futures模块实现并行">
  <meta property="og:description" content="Python实现多线程/多进程，大家常常会用到标准库中的threading和multiprocessing模块。
但从Python3.2开始，标准库为我们提供了concurrent.futures模块，它提供了ThreadPoolExecutor和ProcessPoolExecutor两个类，实现了对threading和multiprocessing的进一步抽象，使得开发者只需编写少量代码即可让程序实现并行计算。
">
  <meta property="og:url" content="https://www.wentixiaogege.com/post/python-concurrent-futures/">
  <meta property="og:image" content="/images/avatar.png">




<meta name="generator" content="Hugo 0.57.2">


<link rel="canonical" href="https://www.wentixiaogege.com/post/python-concurrent-futures/">

<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="format-detection" content="telephone=no,email=no,adress=no">
<meta http-equiv="Cache-Control" content="no-transform">


<meta name="robots" content="index,follow">
<meta name="referrer" content="origin-when-cross-origin">
<meta name="google-site-verification" content="_moDmnnBNVLBN1rzNxyGUGdPHE20YgbmrtzLIbxaWFc">
<meta name="msvalidate.01" content="22596E34341DD1D17D6022C44647E587">





<meta name="theme-color" content="#02b875">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="wentixiaogege">
<meta name="msapplication-tooltip" content="wentixiaogege">
<meta name='msapplication-navbutton-color' content="#02b875">
<meta name="msapplication-TileColor" content="#02b875">
<meta name="msapplication-TileImage" content="/icons/icon-144x144.png">
<link rel="icon" href="https://www.wentixiaogege.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://www.wentixiaogege.com/icons/icon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://www.wentixiaogege.com/icons/icon-32x32.png">
<link rel="icon" sizes="192x192" href="https://www.wentixiaogege.com/icons/icon-192x192.png">
<link rel="apple-touch-icon" href="https://www.wentixiaogege.com/icons/icon-152x152.png">
<link rel="manifest" href="https://www.wentixiaogege.com/manifest.json">


<link rel="preload" href="https://www.wentixiaogege.com/styles/main-rendered.min.css" as="style">


<link rel="preload" href="https://fonts.googleapis.com/css?family=Lobster" as="style">
<link rel="preload" href="https://www.wentixiaogege.com/images/avatar.png" as="image">
<link rel="preload" href="https://www.wentixiaogege.com/images/grey-prism.svg" as="image">


<style>
  body {
    background: rgb(244, 243, 241) url('/images/grey-prism.svg') repeat fixed;
  }
</style>
<link rel="stylesheet" href="https://www.wentixiaogege.com/styles/main-rendered.min.css">


<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lobster">



<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.2/dist/medium-zoom.min.js"></script>




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/video.js@7.3.0/dist/video-js.min.css">



  
  
<!--[if lte IE 8]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-ie8@1.1.2/dist/videojs-ie8.min.js"></script>
<![endif]-->

<!--[if lte IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/eligrey-classlist-js-polyfill@1.2.20180112/classList.min.js"></script>
<![endif]-->


</head>
  <body>
    <div class="suspension">
      <a role="button" aria-label="Go to top" title="Go to top" class="to-top is-hide"><span class="icon icon-up" aria-hidden="true"></span></a>
      
        
	<a role="button" aria-label="Go to comments" title="Go to comments" class="to-comment" href="#disqus_thread"><span class="icon icon-comment" aria-hidden="true"></span></a>
        
      
    </div>
    
    
  <header class="site-header">
  <img class="avatar" src="https://www.wentixiaogege.com/images/avatar.png" alt="Avatar">
  
  <h2 class="title">wentixiaogege</h2>
  
  <p class="subtitle">Getty Images Contributor. I&#39;m not a photographer but a data enthusiast.</p>
  <button class="menu-toggle" type="button" aria-label="Main Menu" aria-expanded="false" tab-index="0">
    <span class="icon icon-menu" aria-hidden="true"></span>
  </button>

  <nav class="site-menu collapsed">
    <h2 class="offscreen">Main Menu</h2>
    <ul class="menu-list">
      
      
      
      
        <li class="menu-item
          
          
           is-active">
          <a href="https://www.wentixiaogege.com/">Home</a>
        </li>
      
        <li class="menu-item
          
          
          ">
          <a href="https://github.com/wentixiaogege">GitHub</a>
        </li>
      
        <li class="menu-item
          
          
          ">
          <a href="https://wentixiaogegefoto.tuchong.com/">Gallery</a>
        </li>
      
        <li class="menu-item
          
          
          ">
          <a href="https://www.wentixiaogege.com/tags/">Tags</a>
        </li>
      
        <li class="menu-item
          
          
          ">
          <a href="https://www.wentixiaogege.com/links/">Links</a>
        </li>
      
        <li class="menu-item
          
          
          ">
          <a href="https://www.wentixiaogege.com/resume/">Resume</a>
        </li>
      
        <li class="menu-item
          
          
          ">
          <a href="https://www.wentixiaogege.com/about/">About</a>
        </li>
      
    </ul>
  </nav>
  <nav class="social-menu collapsed">
    <h2 class="offscreen">Social Networks</h2>
    <ul class="social-list"><li class="social-item">
          <a href="mailto:hi@wentixiaogege.com" title="Email" aria-label="Email">
            <span class="icon icon-email" aria-hidden="true"></span>
          </a>
        </li><li class="social-item">
          <a href="//github.com/wentixiaogege" rel="me" title="GitHub" aria-label="GitHub">
	    <span class="icon icon-github" aria-hidden="true"></span>
          </a>
        </li><li class="social-item">
          <a href="//www.instagram.com/wentixiaogege" rel="me" title="Instagram" aria-label="Instagram">
            <span class="icon icon-instagram" aria-hidden="true"></span>
          </a>
        </li><li class="social-item">
          <a href="//weibo.com/bother7" rel="me" title="Weibo" aria-label="Weibo">
            <span class="icon icon-weibo" aria-hidden="true"></span>
          </a>
        </li><li class="social-item">
          <a href="https://www.wentixiaogege.com/images/qrcode.jpg" rel="me" title="Wechat" aria-label="Wechat">
            <span class="icon icon-wechat" aria-hidden="true"></span>
          </a>
        </li></ul>
  </nav>
</header>

  <section class="main post-detail">
    <header class="post-header">
      <h1 class="post-title">用concurrent.futures模块实现并行</h1>
      <p class="post-meta">@Qi Zhang · May 8, 2019 · 5 min read</p>
    </header>
    <article class="post-content"><p>Python实现多线程/多进程，大家常常会用到标准库中的<code>threading</code>和<code>multiprocessing</code>模块。</p>

<p>但从Python3.2开始，标准库为我们提供了<code>concurrent.futures</code>模块，它提供了<code>ThreadPoolExecutor</code>和<code>ProcessPoolExecutor</code>两个类，实现了对<code>threading</code>和<code>multiprocessing</code>的进一步抽象，使得开发者只需编写少量代码即可让程序实现并行计算。</p>

<h2 id="threadpoolexecutor和processpoolexecutor">ThreadPoolExecutor和ProcessPoolExecutor</h2>

<p><code>concurrent.futures</code>模块的基础是<code>Exectuor</code>抽象类（包括<code>map</code>, <code>submit</code>, <code>shutdown</code>方法），但是它不能被直接使用。</p>

<p>一般会对它的两个子类<code>ThreadPoolExecutor</code>和<code>ProcessPoolExecutor</code>进行调用，两者分别被用来创建线程池和进程池。</p>

<p>当项目达到一定的规模，频繁创建/销毁进程或者线程是非常消耗资源的，这个时候我们就要编写自己的线程池/进程池，以空间换时间。</p>

<p>我们可以将相应的tasks直接放入线程池/进程池，不需要维护<code>Queue</code>来操心死锁的问题，线程池/进程池会自动帮我们调度。</p>

<h4 id="1-threadpoolexecutor创建线程池">1. ThreadPoolExecutor创建线程池</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> concurrent.futures <span style="color:#f92672">import</span> ThreadPoolExecutor
<span style="color:#f92672">import</span> time

t0 <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">return_future_result</span>(message1, message2):
    s <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">50000000</span>):
        s <span style="color:#f92672">*=</span> i
    <span style="color:#66d9ef">return</span> message1, message2

pool <span style="color:#f92672">=</span> ThreadPoolExecutor(max_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>)  <span style="color:#75715e"># 创建一个最大可容纳3个task的线程池</span>

future1 <span style="color:#f92672">=</span> pool<span style="color:#f92672">.</span>submit(return_future_result, message1<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;hello&#34;</span>,
                      message2<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;111&#39;</span>)  <span style="color:#75715e"># 往线程池里面加入一个task</span>
future2 <span style="color:#f92672">=</span> pool<span style="color:#f92672">.</span>submit(return_future_result, message2<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;world&#34;</span>,
                      message1<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;222&#39;</span>)  <span style="color:#75715e"># 往线程池里面加入一个task</span>

<span style="color:#66d9ef">print</span>(future1<span style="color:#f92672">.</span>done())  <span style="color:#75715e"># 判断task1是否结束</span>
<span style="color:#66d9ef">print</span>(future2<span style="color:#f92672">.</span>done())  <span style="color:#75715e"># 判断task2是否结束</span>
<span style="color:#66d9ef">print</span>(future1<span style="color:#f92672">.</span>result())  <span style="color:#75715e"># 查看task1返回的结果</span>
<span style="color:#66d9ef">print</span>(future2<span style="color:#f92672">.</span>result())  <span style="color:#75715e"># 查看task2返回的结果</span>
<span style="color:#66d9ef">print</span>(future1<span style="color:#f92672">.</span>done())  <span style="color:#75715e"># 判断task1是否结束</span>
<span style="color:#66d9ef">print</span>(future2<span style="color:#f92672">.</span>done())  <span style="color:#75715e"># 判断task2是否结束</span>
t1 <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
<span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#34;total time consumed: {(t1-t0):{2}.{5}}&#34;</span>)</code></pre></div>
<p>输出：</p>

<hr />

<pre><code>False
False
('hello', '111')
('222', 'world')
True
True
total time consumed: 9.325

</code></pre>

<hr />

<h4 id="2-processpoolexecutor创建进程池">2. ProcessPoolExecutor创建进程池</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> concurrent.futures <span style="color:#f92672">import</span> ProcessPoolExecutor
<span style="color:#f92672">import</span> time

t0 <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">return_future_result</span>(message1, message2):
    s <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">50000000</span>):
        s <span style="color:#f92672">*=</span> i
    <span style="color:#66d9ef">return</span> message1, message2


pool <span style="color:#f92672">=</span> ProcessPoolExecutor(max_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>)  <span style="color:#75715e"># 创建一个最大可容纳3个task的进程池</span>

future1 <span style="color:#f92672">=</span> pool<span style="color:#f92672">.</span>submit(return_future_result, message1<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;hello&#34;</span>,
                      message2<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;111&#39;</span>)  <span style="color:#75715e"># 往进程池里面加入一个task</span>
future2 <span style="color:#f92672">=</span> pool<span style="color:#f92672">.</span>submit(return_future_result, message2<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;world&#34;</span>,
                      message1<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;222&#39;</span>)  <span style="color:#75715e"># 往进程池里面加入一个task</span>

<span style="color:#66d9ef">print</span>(future1<span style="color:#f92672">.</span>done())  <span style="color:#75715e"># 判断task1是否结束</span>
<span style="color:#66d9ef">print</span>(future2<span style="color:#f92672">.</span>done())  <span style="color:#75715e"># 判断task2是否结束</span>
<span style="color:#66d9ef">print</span>(future1<span style="color:#f92672">.</span>result())  <span style="color:#75715e"># 查看task1返回的结果</span>
<span style="color:#66d9ef">print</span>(future2<span style="color:#f92672">.</span>result())  <span style="color:#75715e"># 查看task2返回的结果</span>
<span style="color:#66d9ef">print</span>(future1<span style="color:#f92672">.</span>done())  <span style="color:#75715e"># 判断task1是否结束</span>
<span style="color:#66d9ef">print</span>(future2<span style="color:#f92672">.</span>done())  <span style="color:#75715e"># 判断task2是否结束</span>

t1 <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
<span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#34;total time consumed: {(t1-t0):{2}.{5}}&#34;</span>)</code></pre></div>
<p>输出：</p>

<hr />

<pre><code>False
False
('hello', '111')
('222', 'world')
True
True
total time consumed: 3.7551
</code></pre>

<hr />

<p>可以看到用进程池的时间小于线程池。由于GIL(global interpreter lock, 全局解释锁)的存在，使用多线程并不会真正意义上实现并发，使用多进程可以通过子进程的形式同时运行多个解释器，而它们的GIL是独立的，这样就可以是python程序充分利用多核CPU进行并行计算。</p>

<h4 id="3-future类-https-docs-python-org-3-library-concurrent-futures-html-future-objects">3. <a href="https://docs.python.org/3/library/concurrent.futures.html#future-objects">Future类</a></h4>

<p>一般由<code>Executor.submit()</code>创建，将可调用对象封装为异步执行。future是一种便利的模式用来追踪异步调用的结果。
常用的方法有<code>done()</code>, <code>result()</code>, <code>exception()</code>, <code>add_done_callback()</code>等。</p>

<h2 id="map和submit方法">map和submit方法</h2>

<p><code>ThreadPoolExecutor</code>和<code>ProcessPoolExecutor</code>常用的方法有<code>map</code>和<code>submit</code>。</p>

<h4 id="1-map">1. map</h4>

<p><code>map(func, *iterables, timeout=None, chunksize=1)</code></p>

<p><code>map</code>方法类似于python标准库中的<a href="https://docs.python.org/3/library/functions.html#map">map方法</a>。不同的是：</p>

<ul>
<li>这里的可迭代对象（iterables）是被立即collect的，而不是惰性的执行返回；</li>
<li>func是异步执行的，可以实现并发。</li>
</ul>

<p>需要注意的是，当func有多个参数时，如果对多个可迭代对象进行<code>map</code>操作时，最短的可迭代对象耗尽时则整个迭代也会结束，似于python内置的<code>map</code>方法。如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> concurrent.futures <span style="color:#f92672">import</span> ThreadPoolExecutor
<span style="color:#f92672">import</span> time

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">return_future_result</span>(message1, message2):
    time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
    <span style="color:#66d9ef">return</span> message1, message2

lst1 <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;ddddd&#39;</span>, <span style="color:#e6db74">&#34;cccccc&#34;</span>, <span style="color:#e6db74">&#39;eeeeeeeee&#39;</span>]
lst2 <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;1111111&#39;</span>, <span style="color:#e6db74">&#39;33333&#39;</span>, <span style="color:#e6db74">&#39;222222&#39;</span>, <span style="color:#e6db74">&#39;555555&#39;</span>]

<span style="color:#75715e"># We can use a with statement to ensure threads are cleaned up promptly</span>
<span style="color:#66d9ef">with</span> concurrent<span style="color:#f92672">.</span>futures<span style="color:#f92672">.</span>ThreadPoolExecutor(max_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">as</span> executor:
    a <span style="color:#f92672">=</span> executor<span style="color:#f92672">.</span>map(return_future_result, lst1, lst2)

<span style="color:#66d9ef">print</span>(a)
<span style="color:#66d9ef">print</span>(list(a))

<span style="color:#75715e"># 输出：</span>
<span style="color:#f92672">&lt;</span>generator object Executor<span style="color:#f92672">.</span>map<span style="color:#f92672">.&lt;</span>locals<span style="color:#f92672">&gt;.</span>result_iterator at <span style="color:#ae81ff">0x1075f0468</span><span style="color:#f92672">&gt;</span>
[(<span style="color:#e6db74">&#39;ddddd&#39;</span>, <span style="color:#e6db74">&#39;1111111&#39;</span>), (<span style="color:#e6db74">&#39;cccccc&#39;</span>, <span style="color:#e6db74">&#39;33333&#39;</span>), (<span style="color:#e6db74">&#39;eeeeeeeee&#39;</span>, <span style="color:#e6db74">&#39;222222&#39;</span>)]  <span style="color:#75715e"># no &#39;555555&#39;</span></code></pre></div>
<p>函数有多参数的时候，我们可以通过<code>functools.partial</code>来“固定”一些参数：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> concurrent.futures <span style="color:#f92672">import</span> ThreadPoolExecutor
<span style="color:#f92672">import</span> time
<span style="color:#f92672">import</span> functools

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">return_future_result</span>(message1, message2):
    time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
    <span style="color:#66d9ef">return</span> message1, message2

lst1 <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;ddddd&#39;</span>, <span style="color:#e6db74">&#34;cccccc&#34;</span>, <span style="color:#e6db74">&#39;eeeeeeeee&#39;</span>]

return_future_result_new <span style="color:#f92672">=</span> functools<span style="color:#f92672">.</span>partial(
    return_future_result, message2<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;fixed_message2&#39;</span>)

<span style="color:#75715e"># We can use a with statement to ensure threads are cleaned up promptly</span>
<span style="color:#66d9ef">with</span> concurrent<span style="color:#f92672">.</span>futures<span style="color:#f92672">.</span>ThreadPoolExecutor(max_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">as</span> executor:
    a <span style="color:#f92672">=</span> executor<span style="color:#f92672">.</span>map(return_future_result_new, lst1)

<span style="color:#66d9ef">print</span>(a)
<span style="color:#66d9ef">print</span>(list(a))
<span style="color:#75715e"># 输出：</span>
<span style="color:#f92672">&lt;</span>generator object Executor<span style="color:#f92672">.</span>map<span style="color:#f92672">.&lt;</span>locals<span style="color:#f92672">&gt;.</span>result_iterator at <span style="color:#ae81ff">0x108e76f10</span><span style="color:#f92672">&gt;</span>
[(<span style="color:#e6db74">&#39;ddddd&#39;</span>, <span style="color:#e6db74">&#39;fixed_message2&#39;</span>), (<span style="color:#e6db74">&#39;cccccc&#39;</span>, <span style="color:#e6db74">&#39;fixed_message2&#39;</span>), (<span style="color:#e6db74">&#39;eeeeeeeee&#39;</span>, <span style="color:#e6db74">&#39;fixed_message2&#39;</span>)]</code></pre></div>
<h4 id="2-submit">2. submit</h4>

<p><code>submit(fn, *args, **kwargs)</code>，会调用<code>fn(*args **kwargs)</code> 并会返回一个<code>Future</code>对象，来保存程序执行的状态和结果。
在使用<code>submit</code>的过程中需要注意，一些函数内部的错误会被忽略，一些潜在的bug会不容易发现，例如有一些I/O操作出错的话，很容易被我们忽略。比如：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> time
<span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd
<span style="color:#f92672">from</span> concurrent.futures <span style="color:#f92672">import</span> ProcessPoolExecutor

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">return_future_result</span>(num):
    df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#34;no_such_file_</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">.csv&#34;</span><span style="color:#f92672">%</span>(num))
    df<span style="color:#f92672">.</span>to_csv(<span style="color:#e6db74">&#34;no_such_file_</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">.csv&#34;</span><span style="color:#f92672">%</span>(num),index<span style="color:#f92672">=</span>None)

<span style="color:#66d9ef">with</span> ProcessPoolExecutor(max_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">as</span> pool:
    future1 <span style="color:#f92672">=</span> pool<span style="color:#f92672">.</span>submit(return_future_result, <span style="color:#ae81ff">666</span>)

<span style="color:#66d9ef">print</span>(future1<span style="color:#f92672">.</span>done()) <span style="color:#75715e"># True</span>

<span style="color:#66d9ef">print</span>(future1<span style="color:#f92672">.</span>exception()) <span style="color:#75715e"># File b&#39;no_such_file_666.csv&#39; does not exist</span>

<span style="color:#66d9ef">print</span>(future1<span style="color:#f92672">.</span>result()) <span style="color:#75715e"># 会报错： FileNotFoundError: File b&#39;no_such_file_666.csv&#39; does not exist</span></code></pre></div>
<p>其中的错误，我们可以直观的从运行结果中得出。同时，从运行结果可看出，<code>as_completed</code>不是按照URLS列表元素的顺序返回的，会返回先执行完的结果。</p>

<p>我们可以在程序执行完后，用try去catch结果中的错误，使用方法如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> concurrent.futures <span style="color:#f92672">import</span> ThreadPoolExecutor, as_completed
<span style="color:#f92672">import</span> urllib.request <span style="color:#f92672">as</span> ur

URLS <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;https://www.python.org/&#39;</span>, <span style="color:#e6db74">&#39;http://www.taobao.com&#39;</span>,
        <span style="color:#e6db74">&#39;http://www.baidu.com&#39;</span>, <span style="color:#e6db74">&#39;http://www.cctv.com/&#39;</span>, <span style="color:#e6db74">&#39;### I AM A BUG ###&#39;</span>]

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load_url</span>(url, timeout):
    <span style="color:#66d9ef">with</span> ur<span style="color:#f92672">.</span>urlopen(url, timeout<span style="color:#f92672">=</span>timeout) <span style="color:#66d9ef">as</span> conn:
        <span style="color:#66d9ef">return</span> conn<span style="color:#f92672">.</span>read()

<span style="color:#75715e"># We can use a with statement to ensure threads are cleaned up promptly</span>
<span style="color:#66d9ef">with</span> ThreadPoolExecutor(max_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>) <span style="color:#66d9ef">as</span> executor:
    <span style="color:#75715e"># Start the load operations and mark each future with its URL</span>
    future_to_url <span style="color:#f92672">=</span> {executor<span style="color:#f92672">.</span>submit(load_url, url, <span style="color:#ae81ff">60</span>): url <span style="color:#66d9ef">for</span> url <span style="color:#f92672">in</span> URLS}
    <span style="color:#66d9ef">for</span> future <span style="color:#f92672">in</span> as_completed(future_to_url):
        url <span style="color:#f92672">=</span> future_to_url[future]
        <span style="color:#66d9ef">try</span>:
            data <span style="color:#f92672">=</span> future<span style="color:#f92672">.</span>result()
        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> exc:
            <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%r</span><span style="color:#e6db74"> generated an exception: </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> (url, exc))
        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%r</span><span style="color:#e6db74"> page is </span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> bytes&#39;</span> <span style="color:#f92672">%</span> (url, len(data)))

<span style="color:#75715e"># 输出：</span>
<span style="color:#e6db74">&#39;http://www.baidu.com&#39;</span> page <span style="color:#f92672">is</span> <span style="color:#ae81ff">153884</span> bytes
<span style="color:#e6db74">&#39;http://www.cctv.com/&#39;</span> page <span style="color:#f92672">is</span> <span style="color:#ae81ff">298099</span> bytes
<span style="color:#e6db74">&#39;### I AM A BUG ###&#39;</span> generated an exception: unknown url type: <span style="color:#e6db74">&#39;### I AM A BUG ##&#39;</span>
<span style="color:#e6db74">&#39;http://www.taobao.com&#39;</span> page <span style="color:#f92672">is</span> <span style="color:#ae81ff">143891</span> bytes
<span style="color:#e6db74">&#39;https://www.python.org/&#39;</span> page <span style="color:#f92672">is</span> <span style="color:#ae81ff">49114</span> bytes</code></pre></div>
<p>如果执行<code>ThreadPoolExecutor</code>的<code>map</code>方法，结果是<strong>按照URLS列表元素的顺序返回的</strong>，而且用map方法写出的代码更加简洁直观。但是一旦程序有异常，会保存在结果的生成器中，会增加debug的困难，所以更推荐上面的方法。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> concurrent.futures <span style="color:#f92672">import</span> ThreadPoolExecutor
<span style="color:#f92672">import</span> urllib.request <span style="color:#f92672">as</span> ur

URLS <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;https://www.python.org/&#39;</span>, <span style="color:#e6db74">&#39;http://www.taobao.com&#39;</span>,
        <span style="color:#e6db74">&#39;http://www.baidu.com&#39;</span>, <span style="color:#e6db74">&#39;http://www.cctv.com/&#39;</span>] 

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load_url</span>(url):
    <span style="color:#66d9ef">with</span> ur<span style="color:#f92672">.</span>urlopen(url, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">60</span>) <span style="color:#66d9ef">as</span> conn:
        <span style="color:#66d9ef">return</span> conn<span style="color:#f92672">.</span>read()

<span style="color:#75715e"># We can use a with statement to ensure threads are cleaned up promptly</span>
<span style="color:#66d9ef">with</span> ThreadPoolExecutor(max_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>) <span style="color:#66d9ef">as</span> executor:
    <span style="color:#66d9ef">for</span> url, data <span style="color:#f92672">in</span> zip(URLS, executor<span style="color:#f92672">.</span>map(load_url, URLS)):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%r</span><span style="color:#e6db74"> page is </span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> bytes&#39;</span> <span style="color:#f92672">%</span> (url, len(data))) <span style="color:#75715e"># 如果URLS 中有 &#39;### I AM A BUG ###&#39; 则会报错</span>

<span style="color:#75715e"># 输出：</span>
<span style="color:#e6db74">&#39;https://www.python.org/&#39;</span> page <span style="color:#f92672">is</span> <span style="color:#ae81ff">49255</span> bytes
<span style="color:#e6db74">&#39;http://www.taobao.com&#39;</span> page <span style="color:#f92672">is</span> <span style="color:#ae81ff">143891</span> bytes
<span style="color:#e6db74">&#39;http://www.baidu.com&#39;</span> page <span style="color:#f92672">is</span> <span style="color:#ae81ff">153380</span> bytes
<span style="color:#e6db74">&#39;http://www.cctv.com/&#39;</span> page <span style="color:#f92672">is</span> <span style="color:#ae81ff">298099</span> bytes</code></pre></div>
<h2 id="as-completed和wait方法">as_completed和wait方法</h2>

<p><code>concurrent.futures</code>模块中常用的方法有<code>wait</code>, <code>as_completed</code>，用于处理<code>Executors</code>返回的<code>Future</code>对象。</p>

<h4 id="1-as-completed">1. as_completed</h4>

<p><code>concurrent.futures.as_completed(fs, timeout=None)</code> 将<code>Future</code>对象生成一个<strong>迭代器</strong>返回，并且先返回先执行完的结果（<code>map</code>会按照我们传入的可迭代对象中的顺序返回）。</p>

<h6 id="submit-as-completed">submit + as_completed:</h6>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> concurrent.futures <span style="color:#f92672">import</span> ThreadPoolExecutor, as_completed
<span style="color:#f92672">from</span> time <span style="color:#f92672">import</span> sleep
<span style="color:#f92672">from</span> random <span style="color:#f92672">import</span> randint

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">return_after_5_secs</span>(num):
    sleep_time <span style="color:#f92672">=</span> randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>)
    sleep(sleep_time)
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Return of {}, sleep_time: {}&#34;</span><span style="color:#f92672">.</span>format(num, sleep_time)

pool <span style="color:#f92672">=</span> ThreadPoolExecutor(<span style="color:#ae81ff">6</span>)
futures <span style="color:#f92672">=</span> []
<span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">5</span>):
    futures<span style="color:#f92672">.</span>append(pool<span style="color:#f92672">.</span>submit(return_after_5_secs, x))

<span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> as_completed(futures):
    <span style="color:#66d9ef">print</span>(x<span style="color:#f92672">.</span>result())

<span style="color:#75715e"># 输出：</span>
Return of <span style="color:#ae81ff">4</span>, sleep_time: <span style="color:#ae81ff">0</span>
Return of <span style="color:#ae81ff">0</span>, sleep_time: <span style="color:#ae81ff">1</span>
Return of <span style="color:#ae81ff">3</span>, sleep_time: <span style="color:#ae81ff">1</span>
Return of <span style="color:#ae81ff">2</span>, sleep_time: <span style="color:#ae81ff">2</span>
Return of <span style="color:#ae81ff">1</span>, sleep_time: <span style="color:#ae81ff">3</span></code></pre></div>
<h6 id="map">map:</h6>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> concurrent.futures <span style="color:#f92672">import</span> ThreadPoolExecutor
<span style="color:#f92672">from</span> time <span style="color:#f92672">import</span> sleep
<span style="color:#f92672">from</span> random <span style="color:#f92672">import</span> randint

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">return_after_5_secs</span>(num):
    sleep_time <span style="color:#f92672">=</span> randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>)
    sleep(sleep_time)
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Return of {}, sleep_time: {}&#34;</span><span style="color:#f92672">.</span>format(num, sleep_time)

pool <span style="color:#f92672">=</span> ThreadPoolExecutor(<span style="color:#ae81ff">6</span>)
re_ge <span style="color:#f92672">=</span> pool<span style="color:#f92672">.</span>map(return_after_5_secs, [x <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">5</span>)])

<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> re_ge:
    <span style="color:#66d9ef">print</span>(i)
    
<span style="color:#75715e"># 输出：</span>
Return of <span style="color:#ae81ff">0</span>, sleep_time: <span style="color:#ae81ff">3</span>
Return of <span style="color:#ae81ff">1</span>, sleep_time: <span style="color:#ae81ff">4</span>
Return of <span style="color:#ae81ff">2</span>, sleep_time: <span style="color:#ae81ff">3</span>
Return of <span style="color:#ae81ff">3</span>, sleep_time: <span style="color:#ae81ff">4</span>
Return of <span style="color:#ae81ff">4</span>, sleep_time: <span style="color:#ae81ff">4</span></code></pre></div>
<h4 id="2-wait">2. wait</h4>

<p><code>concurrent.futures.wait(fs, timeout=None, return_when=ALL_COMPLETED)</code>有更大的自由度，它将一个<code>Future</code>列表作为参数，并阻塞程序执行，最终会根据<code>return_when</code>等待<code>Future</code>对象完成到某个状态才返回结果，<code>return_when</code>可选参数有：<code>FIRST_COMPLETED</code>, <code>FIRST_EXCEPTION</code> 和 <code>ALL_COMPLETED</code>。</p>

<p>返回结果为一个包含两个集合的<code>named tuple</code>，其中一个集合包含完成的，另一个为未完成的。</p>

<h6 id="如果采用默认的-all-completed-程序会阻塞直到线程池里面的所有任务都完成">如果采用默认的<code>ALL_COMPLETED</code>，程序会阻塞直到线程池里面的所有任务都完成：</h6>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> concurrent.futures <span style="color:#f92672">import</span> ThreadPoolExecutor, wait, as_completed
<span style="color:#f92672">import</span> time
<span style="color:#f92672">from</span> random <span style="color:#f92672">import</span> randint

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">return_after_5_secs</span>(num):
    sleep_time <span style="color:#f92672">=</span> randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>)
    time<span style="color:#f92672">.</span>sleep(sleep_time)
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Return of {}, sleep_time: {}&#34;</span><span style="color:#f92672">.</span>format(num, sleep_time)

pool <span style="color:#f92672">=</span> ThreadPoolExecutor(<span style="color:#ae81ff">6</span>)
futures <span style="color:#f92672">=</span> []
<span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">5</span>):
    futures<span style="color:#f92672">.</span>append(pool<span style="color:#f92672">.</span>submit(return_after_5_secs, x))

t0 <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
<span style="color:#66d9ef">print</span>(wait(futures))
t1 <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
<span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#34;wait {t1-t0:{2}.{5}}&#34;</span>)

<span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> as_completed(futures):
    <span style="color:#66d9ef">print</span>(x<span style="color:#f92672">.</span>result())
    </code></pre></div>
<h6 id="输出如下">输出如下：</h6>

<p><code>return_when='ALL_COMPLETED'</code>，not_done无元素，wait的时间较长</p>

<hr />

<pre><code>DoneAndNotDoneFutures(done={&lt;Future at 0x10a8d8240 state=finished returned str&gt;, &lt;Future at 0x10a856c88 state=finished returned str&gt;, &lt;Future at 0x10a7b8eb8 state=finished returned str&gt;, &lt;Future at 0x10a7bd128 state=finished returned str&gt;, &lt;Future at 0x10a7b81d0 state=finished returned str&gt;}, not_done=set())
wait 4.0018
Return of 2, sleep_time: 2
Return of 3, sleep_time: 1
Return of 1, sleep_time: 4
Return of 0, sleep_time: 4
Return of 4, sleep_time: 0
</code></pre>

<hr />

<h6 id="如果采用-first-completed-参数-程序并不会等到线程池里面所有的任务都完成">如果采用<code>FIRST_COMPLETED</code>参数，程序并不会等到线程池里面所有的任务都完成：</h6>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> concurrent.futures <span style="color:#f92672">import</span> ThreadPoolExecutor, wait, as_completed
<span style="color:#f92672">import</span> time
<span style="color:#f92672">from</span> random <span style="color:#f92672">import</span> randint

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">return_after_5_secs</span>(num):
    sleep_time <span style="color:#f92672">=</span> randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>)
    time<span style="color:#f92672">.</span>sleep(sleep_time)
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Return of {}, sleep_time: {}&#34;</span><span style="color:#f92672">.</span>format(num, sleep_time)

pool <span style="color:#f92672">=</span> ThreadPoolExecutor(<span style="color:#ae81ff">6</span>)
futures <span style="color:#f92672">=</span> []
<span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">5</span>):
    futures<span style="color:#f92672">.</span>append(pool<span style="color:#f92672">.</span>submit(return_after_5_secs, x))

t0 <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
<span style="color:#66d9ef">print</span>(wait(futures, return_when<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;FIRST_COMPLETED&#39;</span>))
t1 <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
<span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#34;wait {t1-t0:{2}.{5}}&#34;</span>)

<span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> as_completed(futures):
    <span style="color:#66d9ef">print</span>(x<span style="color:#f92672">.</span>result())</code></pre></div>
<h6 id="输出如下-1">输出如下：</h6>

<p><code>return_when='FIRST_COMPLETED'</code>，not_done有元素，wait的时间很短</p>

<hr />

<pre><code>DoneAndNotDoneFutures(done={&lt;Future at 0x10a8d8978 state=finished returned str&gt;}, not_done={&lt;Future at 0x10a856e80 state=running&gt;, &lt;Future at 0x10a8d8128 state=running&gt;, &lt;Future at 0x10a7bd048 state=running&gt;, &lt;Future at 0x10a8d92e8 state=running&gt;})
wait 0.00015497 
Return of 3, sleep_time: 0
Return of 4, sleep_time: 1
Return of 0, sleep_time: 2
Return of 2, sleep_time: 2
Return of 1, sleep_time: 4
</code></pre>

<hr />

<h2 id="reference">Reference</h2>

<ul>
<li><p><a href="https://docs.python.org/3/library/concurrent.futures.html">concurrent.futures</a></p></li>

<li><p><a href="https://github.com/python/cpython/tree/3.7/Lib/concurrent/futures">source code</a></p></li>

<li><p><a href="https://docs.python.org/zh-cn/3/library/multiprocessing.html#module-multiprocessing">multiprocessing</a></p></li>

<li><p><a href="https://realpython.com/learning-paths/python-concurrency-parallel-programming/">Python Concurrency &amp; Parallel Programming</a></p></li>

<li><p><a href="https://docs.python.org/zh-cn/3/library/threading.html#module-threading">threading</a></p></li>

<li><p><a href="https://segmentfault.com/a/1190000007926055">Python并发编程之线程池/进程池</a></p></li>

<li><p><a href="https://www.jianshu.com/p/4fab1ffe8665">理解Python的PoolExecutor</a></p></li>
</ul></article>
    <footer class="post-footer">
      
      <ul class="post-tags">
        
          <li><a href="https://www.wentixiaogege.com/tags/python"><span class="tag">Python</span></a></li>
        
          <li><a href="https://www.wentixiaogege.com/tags/%E5%B9%B6%E8%A1%8C"><span class="tag">并行</span></a></li>
        
          <li><a href="https://www.wentixiaogege.com/tags/%E5%A4%9A%E8%BF%9B%E7%A8%8B/%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="tag">多进程/多线程</span></a></li>
        
          <li><a href="https://www.wentixiaogege.com/tags/concurrent.futures"><span class="tag">Concurrent.futures</span></a></li>
        
      </ul>
      
      <p class="post-copyright">
        © This post is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License，please give source if you wish to quote or reproduce.This post was published <strong>180</strong> days ago, content in the post may be inaccurate, even wrong now, please take risk yourself.
      </p>
    </footer>
    
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "orion-4" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
    
  </section>
  
<footer class="site-footer">
  <p>© 2017 wentixiaogege</p>
  <p>Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> with theme <a href="https://github.com/laozhu/hugo-nuo" target="_blank" rel="noopener">Nuo</a>.</p>
  
</footer>


<script src="https://cdn.jsdelivr.net/npm/smooth-scroll@15.0.0/dist/smooth-scroll.min.js"></script>



<script async src="https://cdn.jsdelivr.net/npm/video.js@7.3.0/dist/video.min.js"></script>




<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    },
  });
</script>
<script type="text/x-mathjax-config">
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script>



<script src="https://www.wentixiaogege.com/scripts/index.min.js"></script>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('\/service-worker.js').then(function() {
      console.log('[ServiceWorker] Registered');
    });
  }
</script>




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-XXXXXXXX-X', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>





<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?5713bba443e20a46d066ca93c131f795";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>



  </body>
</html>
